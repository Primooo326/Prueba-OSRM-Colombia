<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>OSRM Navigator ‚Äî Colombia</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #242836;
            --surface3: #2e3344;
            --text: #e4e6ef;
            --text2: #9ca0b0;
            --border: #2e3344;
            --car: #3b82f6;
            --moto: #f97316;
            --van: #14b8a6;
            --truck: #f59e0b;
            --heavy: #ef4444;
            --vroom: #a855f7;
            --success: #22c55e;
            --danger: #ef4444;
            --radius: 10px;
            --shadow: 0 4px 24px rgba(0, 0, 0, .4);
        }

        body,
        html {
            height: 100%;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden
        }

        #app {
            display: flex;
            height: 100vh;
            flex-direction: column
        }

        #main-area {
            display: flex;
            flex: 1;
            overflow: hidden
        }

        /* SIDEBAR */
        #sidebar {
            width: 380px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            z-index: 10;
            border-right: 1px solid var(--border)
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #1e2235, #161929);
            border-bottom: 1px solid var(--border)
        }

        .sidebar-header h1 {
            font-size: 1.15rem;
            font-weight: 800;
            letter-spacing: -.5px
        }

        .sidebar-header h1 span {
            background: linear-gradient(135deg, var(--car), var(--vroom));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .sidebar-header small {
            color: var(--text2);
            font-size: .72rem
        }

        #sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            scrollbar-width: thin;
            scrollbar-color: var(--surface3) transparent
        }

        /* PROFILE SELECTOR */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 16px
        }

        .profile-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 4px;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            background: var(--surface2);
            cursor: pointer;
            transition: all .25s;
            color: var(--text2);
            font-size: .65rem;
            font-weight: 600
        }

        .profile-btn:hover {
            background: var(--surface3);
            transform: translateY(-2px)
        }

        .profile-btn.active {
            border-color: var(--active-color, var(--car));
            background: color-mix(in srgb, var(--active-color, var(--car)) 15%, var(--surface2));
            color: var(--text);
            box-shadow: 0 0 20px color-mix(in srgb, var(--active-color, var(--car)) 30%, transparent)
        }

        .profile-btn .icon {
            font-size: 1.4rem
        }

        .profile-specs {
            font-size: .6rem;
            color: var(--text2);
            text-align: center;
            padding: 6px 10px;
            background: var(--surface2);
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid var(--border)
        }

        /* SERVICE TABS */
        .service-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 14px
        }

        .svc-tab {
            flex: 1;
            padding: 9px 4px;
            text-align: center;
            font-size: .72rem;
            font-weight: 700;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text2);
            cursor: pointer;
            transition: all .2s;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .svc-tab:hover {
            background: var(--surface3)
        }

        .svc-tab.active {
            background: var(--car);
            color: #fff;
            border-color: var(--car)
        }

        .svc-tab.vroom-active {
            background: var(--vroom) !important;
            border-color: var(--vroom) !important;
            color: #fff
        }

        /* CONTROL CARDS */
        .card {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 12px
        }

        .card h4 {
            font-size: .72rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .card h4 .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%
        }

        /* FORM ELEMENTS */
        label {
            font-size: .72rem;
            color: var(--text2);
            font-weight: 600;
            margin-bottom: 4px;
            display: block
        }

        select,
        input[type=number],
        input[type=text] {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: .82rem;
            background: var(--surface);
            color: var(--text);
            margin-bottom: 8px;
            font-family: inherit;
            outline: none;
            transition: border .2s
        }

        select:focus,
        input:focus {
            border-color: var(--car)
        }

        /* POINT LIST */
        .point-list {
            list-style: none
        }

        .point-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            transition: background .2s;
            cursor: grab
        }

        .point-item:hover {
            background: var(--surface3)
        }

        .point-item .info {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .point-item .num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .7rem;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0
        }

        .point-item .coords {
            font-size: .7rem;
            color: var(--text2)
        }

        .point-actions {
            display: flex;
            gap: 4px
        }

        .point-actions button {
            width: 26px;
            height: 26px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: .7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .2s
        }

        .btn-del {
            background: rgba(239, 68, 68, .15);
            color: var(--danger)
        }

        .btn-del:hover {
            background: var(--danger);
            color: #fff
        }

        .btn-edit {
            background: rgba(245, 158, 11, .15);
            color: var(--truck)
        }

        .btn-edit:hover {
            background: var(--truck);
            color: #fff
        }

        /* BUTTONS */
        .btn-exec {
            width: 100%;
            padding: 13px;
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: .85rem;
            cursor: pointer;
            transition: all .25s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: inherit
        }

        .btn-exec.primary {
            background: linear-gradient(135deg, var(--car), #2563eb);
            color: #fff
        }

        .btn-exec.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, .35)
        }

        .btn-exec.vroom-mode {
            background: linear-gradient(135deg, var(--vroom), #7c3aed) !important
        }

        .btn-exec.vroom-mode:hover {
            box-shadow: 0 6px 20px rgba(168, 85, 247, .35) !important
        }

        .btn-exec.danger {
            background: var(--surface3);
            color: var(--text2);
            margin-top: 6px
        }

        .btn-exec.danger:hover {
            background: var(--danger);
            color: #fff
        }

        .btn-reverse {
            background: var(--surface3);
            color: var(--text2);
            border: 1px solid var(--border);
            padding: 7px;
            border-radius: 6px;
            cursor: pointer;
            font-size: .72rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 8px;
            transition: all .2s;
            font-family: inherit
        }

        .btn-reverse:hover {
            background: var(--surface);
            border-color: var(--car);
            color: var(--text)
        }

        /* MAP */
        #map {
            flex: 1;
            background: #111
        }

        /* BOTTOM PANEL */
        #data-panel {
            height: 220px;
            background: var(--surface);
            border-top: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 20;
            transition: height .35s cubic-bezier(.4, 0, .2, 1)
        }

        #data-panel.collapsed {
            height: 40px
        }

        .panel-tabs {
            display: flex;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            min-height: 40px;
            align-items: stretch
        }

        .panel-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: .78rem;
            font-weight: 600;
            color: var(--text2);
            transition: all .2s;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .panel-tab:hover {
            color: var(--text)
        }

        .panel-tab.active {
            color: var(--car);
            border-bottom-color: var(--car)
        }

        .panel-tab.toggle {
            margin-left: auto;
            font-size: 1rem
        }

        .panel-body {
            flex: 1;
            overflow: auto;
            padding: 16px;
            font-size: .82rem
        }

        .json-pre {
            white-space: pre-wrap;
            color: var(--text2);
            font-family: 'Fira Code', monospace;
            font-size: .75rem
        }

        /* ROUTE SUMMARY */
        .route-summary {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        .stat-card {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 18px;
            min-width: 140px
        }

        .stat-card .val {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text)
        }

        .stat-card .lbl {
            font-size: .68rem;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-top: 2px
        }

        /* INSTRUCTIONS */
        .step-list {
            list-style: none
        }

        .step-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background .2s;
            border-radius: 4px;
            padding-left: 8px
        }

        .step-item:hover {
            background: var(--surface2)
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .9rem;
            flex-shrink: 0
        }

        .step-info .street {
            font-weight: 600;
            font-size: .82rem
        }

        .step-info .meta {
            font-size: .7rem;
            color: var(--text2);
            margin-top: 2px
        }

        /* VROOM CONFIG */
        .vroom-config {
            display: none
        }

        .vroom-config.show {
            display: block
        }

        .half-row {
            display: flex;
            gap: 10px
        }

        .half-row>div {
            flex: 1
        }

        /* MATRIX */
        .matrix-wrap {
            overflow: auto
        }

        .matrix-table {
            border-collapse: collapse;
            font-size: .72rem;
            width: 100%
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid var(--border);
            padding: 6px 8px;
            text-align: center
        }

        .matrix-table th {
            background: var(--surface2);
            color: var(--text2);
            font-weight: 600
        }

        .matrix-table td {
            color: var(--text)
        }

        /* MODAL */
        #modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px)
        }

        #modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: 14px;
            width: 340px;
            box-shadow: var(--shadow)
        }

        #modal-header {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border)
        }

        .modal-footer {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 8px
        }

        .modal-footer button {
            padding: 9px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all .2s
        }

        /* LOADING */
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text2)
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--car);
            border-radius: 50%;
            animation: spin .7s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text2);
            font-size: .8rem
        }

        .empty-state .icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: .5
        }
    </style>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdY17gpwgszK7sKVQRlsuDCvM4XNQEmrU&libraries=geometry"></script>
</head>

<body>
    <div id="app">
        <div id="main-area">
            <aside id="sidebar">
                <div class="sidebar-header">
                    <h1><span>OSRM Navigator</span></h1>
                    <small>Multi-Perfil Routing ‚Ä¢ Colombia</small>
                </div>
                <div id="sidebar-scroll">
                    <!-- PROFILE SELECTOR -->
                    <div class="profile-grid" id="profile-grid"></div>
                    <div class="profile-specs" id="profile-specs"></div>

                    <!-- SERVICE TABS -->
                    <div class="service-tabs" id="service-tabs">
                        <div class="svc-tab active" data-svc="route">üß≠ Ruta</div>
                        <div class="svc-tab" data-svc="trip">üîÑ TSP</div>
                        <div class="svc-tab" data-svc="vroom">‚ö° VROOM</div>
                        <div class="svc-tab" data-svc="table">üìä Matriz</div>
                    </div>

                    <p id="desc-text" style="font-size:.72rem;color:var(--text2);margin-bottom:12px;font-style:italic">
                    </p>

                    <!-- SERVICE PARAMS -->
                    <div id="params-container"></div>

                    <!-- VROOM VEHICLE CONFIG -->
                    <div class="card vroom-config" id="vroom-vehicle-config">
                        <h4>
                            <div class="dot" style="background:var(--vroom)"></div>Veh√≠culo VROOM
                        </h4>
                        <div class="half-row">
                            <div><label>Capacidad</label><input type="number" id="v-capacity" value="100"></div>
                            <div><label>Skills (1,2..)</label><input type="text" id="v-skills" placeholder="1, 2"></div>
                        </div>
                        <div class="half-row">
                            <div><label>Inicio Turno (s)</label><input type="number" id="v-start-time" value="0"></div>
                            <div><label>Fin Turno (s)</label><input type="number" id="v-end-time" value="28800"></div>
                        </div>
                    </div>

                    <!-- POINTS -->
                    <div class="card">
                        <h4>
                            <div class="dot" style="background:var(--success)"></div>Puntos (<span
                                id="point-count">0</span>)
                        </h4>
                        <button class="btn-reverse" onclick="reversePoints()">‚Üï Invertir Ruta</button>
                        <ul class="point-list" id="point-list">
                            <li class="empty-state">
                                <div class="icon">üìç</div>Haz clic en el mapa para agregar puntos
                            </li>
                        </ul>
                    </div>

                    <button class="btn-exec primary" id="btn-execute" onclick="executeService()">üöÄ CALCULAR
                        RUTA</button>
                    <button class="btn-exec danger" onclick="clearAll()">üóë LIMPIAR TODO</button>
                </div>
            </aside>
            <div id="map"></div>
        </div>

        <div id="data-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" data-panel="summary">üìä Resumen</div>
                <div class="panel-tab" data-panel="instructions">üß≠ Instrucciones</div>
                <div class="panel-tab" data-panel="json">{ } JSON</div>
                <div class="panel-tab toggle" onclick="togglePanel()">‚¨á</div>
            </div>
            <div class="panel-body">
                <div id="view-summary">
                    <div class="empty-state">
                        <div class="icon">üó∫Ô∏è</div>Selecciona puntos y calcula una ruta
                    </div>
                </div>
                <div id="view-instructions" style="display:none"></div>
                <div id="view-json" style="display:none">
                    <pre class="json-pre">{}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay">
        <div id="modal-content">
            <div id="modal-header">‚öôÔ∏è Configurar Trabajo</div>
            <input type="hidden" id="edit-id">
            <label>Demanda / Entrega</label><input type="number" id="edit-delivery" value="10">
            <label>Tiempo Servicio (s)</label><input type="number" id="edit-service" value="300">
            <div class="half-row">
                <div><label>Ventana Inicio</label><input type="number" id="edit-tw-start" placeholder="0"></div>
                <div><label>Ventana Fin</label><input type="number" id="edit-tw-end" placeholder="86400"></div>
            </div>
            <div class="half-row">
                <div><label>Prioridad (0-100)</label><input type="number" id="edit-priority" value="50"></div>
                <div><label>Skills Req.</label><input type="text" id="edit-skills" placeholder="ej: 1"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" style="background:var(--surface3);color:var(--text2)">Cancelar</button>
                <button onclick="savePointData()" style="background:var(--car);color:#fff">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        /* ========== CONFIG ========== */
        const API_VROOM = "https://osrm.oberon360.com/vroom/", HOST = "http://osrn.oberon360.com";
        const PROFILES = {
            car: { port: 5000, label: "Carro", icon: "üöó", color: "#3b82f6", specs: "2.0m alto ‚Ä¢ 1.9m ancho ‚Ä¢ 2T", h: 2, w: 1.9, wt: "2T" },
            moto: { port: 5001, label: "Moto", icon: "üèçÔ∏è", color: "#f97316", specs: "1.5m alto ‚Ä¢ 1.0m ancho ‚Ä¢ 300kg", h: 1.5, w: 1, wt: "300kg" },
            van: { port: 5002, label: "Van", icon: "üöê", color: "#14b8a6", specs: "2.6m alto ‚Ä¢ 2.2m ancho ‚Ä¢ 3.5T", h: 2.6, w: 2.2, wt: "3.5T" },
            truck_medium: { port: 5003, label: "Cami√≥n", icon: "üöö", color: "#f59e0b", specs: "3.8m alto ‚Ä¢ 2.5m ancho ‚Ä¢ 10T", h: 3.8, w: 2.5, wt: "10T" },
            truck_heavy: { port: 5004, label: "Pesado", icon: "üöõ", color: "#ef4444", specs: "4.5m alto ‚Ä¢ 2.6m ancho ‚Ä¢ 40T", h: 4.5, w: 2.6, wt: "40T" }
        };
        const SVC_DESC = {
            route: "Calcula la ruta m√°s √≥ptima entre los puntos seleccionados.",
            trip: "Optimiza el orden de visita (Problema del Viajero Comerciante).",
            vroom: "Optimizaci√≥n avanzada con restricciones de capacidad, skills y ventanas de tiempo.",
            table: "Genera la matriz de distancias/duraciones NxN entre todos los puntos."
        };
        const MANEUVER_ICONS = {
            depart: "üö©", arrive: "üèÅ", "turn-left": "‚¨ÖÔ∏è", "turn-right": "‚û°Ô∏è", "turn-slight-left": "‚ÜñÔ∏è",
            "turn-slight-right": "‚ÜóÔ∏è", "turn-sharp-left": "‚Ü©Ô∏è", "turn-sharp-right": "‚Ü™Ô∏è",
            "continue": "‚¨ÜÔ∏è", "roundabout-turn": "üîÑ", "merge-left": "üîÄ", "merge-right": "üîÄ",
            "fork-left": "‚ÜôÔ∏è", "fork-right": "‚ÜòÔ∏è", "end-of-road-left": "‚¨ÖÔ∏è", "end-of-road-right": "‚û°Ô∏è",
            "new-name": "‚¨ÜÔ∏è", "straight": "‚¨ÜÔ∏è", roundabout: "üîÑ", "rotary": "üîÑ", uturn: "üîÉ"
        };

        /* ========== STATE ========== */
        let currentService = "route", currentProfile = "car", map, points = [], resultObjects = [], isPanelOpen = true, lastData = null;

        /* ========== INIT ========== */
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13, center: { lat: 4.62, lng: -74.10 },
                disableDefaultUI: true, zoomControl: true,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#8ec3b9" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#304a7d" }] },
                    { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#255763" }] },
                    { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#2c6675" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
                    { featureType: "poi", stylers: [{ visibility: "off" }] },
                    { featureType: "transit", stylers: [{ visibility: "off" }] }
                ]
            });
            map.addListener("click", e => addPoint(e.latLng.lat(), e.latLng.lng()));
            buildProfileGrid();
            bindTabs();
            setService("route");
        }

        function buildProfileGrid() {
            const grid = document.getElementById("profile-grid");
            grid.innerHTML = "";
            Object.entries(PROFILES).forEach(([k, p]) => {
                const btn = document.createElement("div");
                btn.className = "profile-btn" + (k === currentProfile ? " active" : "");
                btn.style.setProperty("--active-color", p.color);
                btn.innerHTML = `<span class="icon">${p.icon}</span>${p.label}`;
                btn.onclick = () => selectProfile(k);
                grid.appendChild(btn);
            });
            updateProfileSpecs();
        }

        function selectProfile(key) {
            currentProfile = key;
            document.querySelectorAll(".profile-btn").forEach(b => b.classList.remove("active"));
            const btns = document.querySelectorAll(".profile-btn");
            const keys = Object.keys(PROFILES);
            const idx = keys.indexOf(key);
            if (btns[idx]) { btns[idx].classList.add("active"); btns[idx].style.setProperty("--active-color", PROFILES[key].color) }
            updateProfileSpecs();
            // Update accent colors
            document.querySelectorAll(".svc-tab.active").forEach(t => { if (!t.classList.contains("vroom-active")) t.style.background = PROFILES[key].color });
            updateMarkerColors();
        }

        function updateProfileSpecs() {
            const p = PROFILES[currentProfile];
            document.getElementById("profile-specs").innerHTML = `${p.icon} <strong>${p.label}</strong> ‚Äî ${p.specs} | Puerto: ${p.port}`;
        }

        function updateMarkerColors() {
            const color = PROFILES[currentProfile].color;
            points.forEach((p, i) => {
                const lbl = currentService === "vroom" && i === 0 ? "D" : String(i + 1);
                p.marker.setIcon({ path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: currentService === "vroom" && i === 0 ? PROFILES[currentProfile].color : color, fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2 });
                p.marker.setLabel({ text: lbl, color: "#fff", fontSize: "11px", fontWeight: "700" });
            });
        }

        /* ========== TABS ========== */
        function bindTabs() {
            document.querySelectorAll(".svc-tab").forEach(t => t.addEventListener("click", () => setService(t.dataset.svc)));
            document.querySelectorAll(".panel-tab[data-panel]").forEach(t => t.addEventListener("click", () => setPanelTab(t.dataset.panel)));
        }

        function setService(svc) {
            currentService = svc;
            const color = PROFILES[currentProfile].color;
            document.querySelectorAll(".svc-tab").forEach(b => {
                b.classList.remove("active", "vroom-active");
                b.style.background = ""; b.style.borderColor = "";
                if (b.dataset.svc === svc) {
                    if (svc === "vroom") { b.classList.add("vroom-active") }
                    else { b.classList.add("active"); b.style.background = color; b.style.borderColor = color }
                }
            });
            document.getElementById("desc-text").innerText = SVC_DESC[svc];
            const btn = document.getElementById("btn-execute");
            btn.className = svc === "vroom" ? "btn-exec primary vroom-mode" : "btn-exec primary";
            btn.innerText = svc === "vroom" ? "‚ö° OPTIMIZAR VROOM" : svc === "table" ? "üìä CALCULAR MATRIZ" : svc === "trip" ? "üîÑ OPTIMIZAR TSP" : "üöÄ CALCULAR RUTA";
            document.getElementById("vroom-vehicle-config").className = svc === "vroom" ? "card vroom-config show" : "card vroom-config";

            // Service-specific params
            const pc = document.getElementById("params-container");
            if (svc === "trip") pc.innerHTML = `<div class="card"><h4>Modo TSP</h4><select id="p-roundtrip"><option value="true">üîÑ Circular (volver al inicio)</option><option value="false">‚û°Ô∏è Lineal (no retorno)</option></select></div>`;
            else if (svc === "route") pc.innerHTML = `<div class="card"><h4>Opciones de Ruta</h4><label><input type="checkbox" id="p-steps" checked style="width:auto;margin-right:6px">Incluir instrucciones paso a paso</label></div>`;
            else pc.innerHTML = "";
            updatePointList();
        }

        /* ========== POINTS ========== */
        function addPoint(lat, lng) {
            const color = PROFILES[currentProfile].color;
            const idx = points.length;
            const lbl = currentService === "vroom" && idx === 0 ? "D" : String(idx + 1);
            const marker = new google.maps.Marker({
                position: { lat, lng }, map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: currentService === "vroom" && idx === 0 ? "#a855f7" : color, fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2 },
                label: { text: lbl, color: "#fff", fontSize: "11px", fontWeight: "700" },
                draggable: true, title: `Punto ${idx + 1}`
            });
            marker.addListener("dragend", () => { const pos = marker.getPosition(); points[idx].lat = pos.lat(); points[idx].lng = pos.lng(); updatePointList() });
            marker.addListener("rightclick", () => removePoint(idx));
            points.push({ lat, lng, marker, delivery: 10, service: 300, twStart: null, twEnd: null, priority: 50, skills: "" });
            updatePointList();
        }

        function updatePointList() {
            const list = document.getElementById("point-list");
            document.getElementById("point-count").innerText = points.length;
            if (!points.length) { list.innerHTML = `<li class="empty-state"><div class="icon">üìç</div>Haz clic en el mapa para agregar puntos</li>`; return }
            list.innerHTML = "";
            const color = PROFILES[currentProfile].color;
            points.forEach((p, i) => {
                const isDepot = currentService === "vroom" && i === 0;
                const role = isDepot ? "üè¢ Dep√≥sito" : currentService === "vroom" ? `üì¶ Job ${i}` : `Punto ${i + 1}`;
                const bgColor = isDepot ? "var(--vroom)" : color;
                let actions = `<button class="btn-del" onclick="event.stopPropagation();removePoint(${i})" title="Eliminar">‚úï</button>`;
                if (currentService === "vroom" && !isDepot) actions = `<button class="btn-edit" onclick="event.stopPropagation();openModal(${i})" title="Configurar">‚öô</button>` + actions;
                list.innerHTML += `<li class="point-item"><div class="info"><div class="num" style="background:${bgColor}">${isDepot ? "D" : i + 1}</div><div><strong style="font-size:.78rem">${role}</strong><div class="coords">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div></div></div><div class="point-actions">${actions}</div></li>`;
            });
        }

        function removePoint(idx) {
            points[idx].marker.setMap(null); points.splice(idx, 1);
            points.forEach((p, i) => {
                const lbl = currentService === "vroom" && i === 0 ? "D" : String(i + 1);
                p.marker.setLabel({ text: lbl, color: "#fff", fontSize: "11px", fontWeight: "700" });
                // Rebind dragend
                google.maps.event.clearListeners(p.marker, "dragend");
                google.maps.event.clearListeners(p.marker, "rightclick");
                const ci = i;
                p.marker.addListener("dragend", () => { const pos = p.marker.getPosition(); points[ci].lat = pos.lat(); points[ci].lng = pos.lng(); updatePointList() });
                p.marker.addListener("rightclick", () => removePoint(ci));
            });
            updatePointList();
        }

        function reversePoints() {
            if (points.length < 2) return;
            points.reverse();
            points.forEach((p, i) => {
                const lbl = currentService === "vroom" && i === 0 ? "D" : String(i + 1);
                p.marker.setLabel({ text: lbl, color: "#fff", fontSize: "11px", fontWeight: "700" });
            });
            updatePointList();
        }

        function clearAll() {
            points.forEach(p => p.marker.setMap(null)); resultObjects.forEach(o => o.setMap(null));
            points = []; resultObjects = []; lastData = null;
            updatePointList();
            document.getElementById("view-summary").innerHTML = `<div class="empty-state"><div class="icon">üó∫Ô∏è</div>Selecciona puntos y calcula una ruta</div>`;
            document.getElementById("view-instructions").innerHTML = "";
            document.querySelector("#view-json .json-pre").innerText = "{}";
        }

        /* ========== MODAL ========== */
        function openModal(i) {
            const p = points[i];
            document.getElementById("edit-id").value = i;
            document.getElementById("edit-delivery").value = p.delivery;
            document.getElementById("edit-service").value = p.service;
            document.getElementById("edit-tw-start").value = p.twStart || "";
            document.getElementById("edit-tw-end").value = p.twEnd || "";
            document.getElementById("edit-priority").value = p.priority;
            document.getElementById("edit-skills").value = p.skills;
            document.getElementById("modal-overlay").style.display = "flex";
        }
        function closeModal() { document.getElementById("modal-overlay").style.display = "none" }
        function savePointData() {
            const i = parseInt(document.getElementById("edit-id").value), p = points[i];
            p.delivery = parseInt(document.getElementById("edit-delivery").value) || 0;
            p.service = parseInt(document.getElementById("edit-service").value) || 0;
            p.twStart = document.getElementById("edit-tw-start").value ? parseInt(document.getElementById("edit-tw-start").value) : null;
            p.twEnd = document.getElementById("edit-tw-end").value ? parseInt(document.getElementById("edit-tw-end").value) : null;
            p.priority = parseInt(document.getElementById("edit-priority").value) || 50;
            p.skills = document.getElementById("edit-skills").value;
            closeModal(); updatePointList();
        }

        /* ========== API ========== */
        async function executeService() {
            if (points.length < 2) { alert("M√≠nimo 2 puntos."); return }
            const summary = document.getElementById("view-summary");
            summary.innerHTML = `<div class="loading"><div class="spinner"></div>Calculando con perfil ${PROFILES[currentProfile].icon} ${PROFILES[currentProfile].label}...</div>`;
            const pf = PROFILES[currentProfile];
            let url = "", method = "GET", body = null;
            try {
                if (currentService === "vroom") {
                    url = API_VROOM + "/"; method = "POST";
                    const depot = points[0];
                    const vCap = parseInt(document.getElementById("v-capacity").value);
                    const vSk = document.getElementById("v-skills").value;
                    const vSkills = vSk ? vSk.split(",").map(Number) : undefined;
                    const vST = parseInt(document.getElementById("v-start-time").value);
                    const vET = parseInt(document.getElementById("v-end-time").value);
                    body = JSON.stringify({
                        vehicles: [{ id: 1, profile: currentProfile, start: [depot.lng, depot.lat], end: [depot.lng, depot.lat], capacity: [vCap], skills: vSkills, time_window: [vST, vET] }],
                        jobs: points.slice(1).map((p, idx) => {
                            const j = { id: idx + 1, location: [p.lng, p.lat], delivery: [p.delivery], service: p.service, priority: p.priority };
                            if (p.twStart !== null && p.twEnd !== null) j.time_windows = [[p.twStart, p.twEnd]];
                            if (p.skills) j.skills = p.skills.split(",").map(Number);
                            return j;
                        }),
                        options: { g: true }
                    });
                } else {
                    const coords = points.map(p => `${p.lng},${p.lat}`).join(";");
                    url = `${HOST}:${pf.port}/${currentService}/v1/driving/${coords}?overview=full&geometries=polyline`;
                    if (currentService === "route") { const stepsEl = document.getElementById("p-steps"); if (stepsEl && stepsEl.checked) url += "&steps=true" }
                    if (currentService === "trip") url += `&roundtrip=${document.getElementById("p-roundtrip").value}`;
                    if (currentService === "table") url += `&annotations=duration`;
                }
                const res = await fetch(url, { method, headers: body ? { "Content-Type": "application/json" } : undefined, body });
                const data = await res.json(); lastData = data;
                document.querySelector("#view-json .json-pre").innerText = JSON.stringify(data, null, 2);
                renderResults(data);
            } catch (e) { summary.innerHTML = `<div style="color:var(--danger);font-weight:600">‚ùå Error: ${e.message}</div>`; console.error(e) }
        }

        /* ========== RENDER RESULTS ========== */
        function renderResults(data) {
            resultObjects.forEach(o => o.setMap(null)); resultObjects = [];
            const container = document.getElementById("view-summary");
            const instrContainer = document.getElementById("view-instructions");
            container.innerHTML = ""; instrContainer.innerHTML = "";
            const color = PROFILES[currentProfile].color;

            if (currentService === "vroom") { renderVroom(data, container); return }
            if (currentService === "table") { renderTable(data, container); return }

            // Route or Trip
            const routes = data.routes || data.trips;
            if (!routes || !routes.length) { container.innerHTML = "<div style='color:var(--danger)'>No se encontr√≥ ruta.</div>"; return }
            const r = routes[0];
            if (r.geometry) drawPolyline(r.geometry, color);

            const dist = (r.distance / 1000).toFixed(1), dur = r.duration;
            const h = Math.floor(dur / 3600), m = Math.floor((dur % 3600) / 60);
            container.innerHTML = `<div class="route-summary">
    <div class="stat-card"><div class="val" style="color:${color}">${dist} km</div><div class="lbl">Distancia total</div></div>
    <div class="stat-card"><div class="val">${h}h ${m}m</div><div class="lbl">Tiempo estimado</div></div>
    <div class="stat-card"><div class="val">${PROFILES[currentProfile].icon}</div><div class="lbl">${PROFILES[currentProfile].label}</div></div>
  </div>`;

            // Instructions
            if (r.legs) {
                let html = `<ul class="step-list">`;
                r.legs.forEach((leg, li) => {
                    if (leg.steps) {
                        leg.steps.forEach(s => {
                            const icon = MANEUVER_ICONS[s.maneuver?.type] || "‚û°Ô∏è";
                            const name = s.name || "V√≠a sin nombre";
                            const d = (s.distance / 1000).toFixed(2);
                            const t = Math.round(s.duration / 60);
                            html += `<li class="step-item"><div class="step-icon">${icon}</div><div class="step-info"><div class="street">${name}</div><div class="meta">${d} km ‚Ä¢ ${t} min</div></div></li>`;
                        });
                    }
                });
                html += `</ul>`;
                instrContainer.innerHTML = html;
            } else { instrContainer.innerHTML = `<div class="empty-state">Sin instrucciones detalladas.</div>` }
        }

        function renderVroom(data, container) {
            if (!data.routes || !data.routes.length) { container.innerHTML = "No se encontr√≥ soluci√≥n."; return }
            const colors = ["#a855f7", "#f97316", "#3b82f6", "#ef4444"];
            let html = `<div class="route-summary">
    <div class="stat-card"><div class="val" style="color:var(--vroom)">${data.routes.length}</div><div class="lbl">Veh√≠culos usados</div></div>
    <div class="stat-card"><div class="val">${data.summary?.computing_times?.loading || 0}ms</div><div class="lbl">Tiempo c√≥mputo</div></div>
  </div>`;
            data.routes.forEach((r, i) => {
                const c = colors[i % colors.length];
                if (r.geometry) drawPolyline(r.geometry, c);
                html += `<div style="border-left:3px solid ${c};padding:8px 12px;margin-bottom:8px;border-radius:0 6px 6px 0;background:var(--surface2)">
      <strong>Veh√≠culo ${r.vehicle}</strong> ‚Äî ${(r.distance / 1000).toFixed(1)}km ‚Ä¢ ${Math.round(r.duration / 60)}min
      <div style="margin-top:6px;font-size:.72rem;color:var(--text2)">`;
                r.steps.forEach(s => {
                    if (s.type === "job") html += `<div>üì¶ Job ${s.job} ‚Äî Arr: ${fmtTime(s.arrival)}</div>`;
                });
                html += `</div></div>`;
            });
            if (data.unassigned && data.unassigned.length) {
                html += `<div style="color:var(--danger);font-weight:600;margin-top:10px">‚ö†Ô∏è ${data.unassigned.length} trabajos sin asignar</div>`;
            }
            container.innerHTML = html;
        }

        function renderTable(data, container) {
            if (!data.durations) { container.innerHTML = "Sin datos de matriz."; return }
            const n = data.durations.length;
            let html = `<div class="route-summary"><div class="stat-card"><div class="val">${n}√ó${n}</div><div class="lbl">Dimensi√≥n matriz</div></div></div>`;
            html += `<div class="matrix-wrap"><table class="matrix-table"><tr><th></th>`;
            for (let j = 0; j < n; j++)html += `<th>P${j + 1}</th>`;
            html += `</tr>`;
            for (let i = 0; i < n; i++) {
                html += `<tr><th>P${i + 1}</th>`;
                for (let j = 0; j < n; j++) {
                    const v = Math.round(data.durations[i][j] / 60);
                    const intensity = Math.min(v / 60, 1);
                    const bg = `rgba(59,130,246,${intensity * 0.4})`;
                    html += `<td style="background:${bg}">${v}m</td>`;
                }
                html += `</tr>`;
            }
            html += `</table></div>`;
            container.innerHTML = html;
        }

        /* ========== HELPERS ========== */
        function fmtTime(s) { const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60); return `${h}:${String(m).padStart(2, "0")}` }

        function drawPolyline(encoded, color) {
            const path = google.maps.geometry.encoding.decodePath(encoded);
            const poly = new google.maps.Polyline({ path, strokeColor: color, strokeWeight: 5, strokeOpacity: .85, map });
            resultObjects.push(poly);
            const bounds = new google.maps.LatLngBounds();
            path.forEach(p => bounds.extend(p));
            map.fitBounds(bounds);
        }

        function setPanelTab(t) {
            document.querySelectorAll(".panel-tab[data-panel]").forEach(x => x.classList.remove("active"));
            document.querySelector(`.panel-tab[data-panel="${t}"]`).classList.add("active");
            document.getElementById("view-summary").style.display = t === "summary" ? "block" : "none";
            document.getElementById("view-instructions").style.display = t === "instructions" ? "block" : "none";
            document.getElementById("view-json").style.display = t === "json" ? "block" : "none";
        }

        function togglePanel() {
            const p = document.getElementById("data-panel");
            isPanelOpen = !isPanelOpen;
            p.classList.toggle("collapsed");
            document.querySelector(".panel-tab.toggle").innerText = isPanelOpen ? "‚¨á" : "‚¨Ü";
        }

        window.onload = initMap;
    </script>
</body>

</html>