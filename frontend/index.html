<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>OSRM Multi-Perfil + VROOM Master UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --vroom: #8e44ad;
            --light: #ecf0f1;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
        }

        body,
        html {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        /* LAYOUT */
        #app {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        #main-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        #sidebar {
            width: 360px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

        #sidebar-header {
            padding: 15px;
            background: var(--primary);
            color: white;
        }

        #sidebar-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        #sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* TABS */
        .service-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 4px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            text-align: center;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #eee;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            font-weight: bold;
        }

        .tab-btn.vroom-active {
            background: var(--vroom) !important;
            border-color: var(--vroom) !important;
            color: white;
        }

        /* CONTROLES */
        .control-group {
            margin-bottom: 15px;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .control-group h4 {
            margin: 0 0 10px 0;
            font-size: 0.85rem;
            color: var(--accent);
            text-transform: uppercase;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #444;
            font-weight: 600;
        }

        select,
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .vehicle-select {
            border: 2px solid var(--accent);
            background-color: #f0f8ff;
            font-weight: bold;
            color: var(--primary);
        }

        /* LISTA DE PUNTOS */
        #point-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
            color: #555;
        }

        #point-list li {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .point-actions {
            display: flex;
            gap: 5px;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 0.8rem;
        }

        .btn-del {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 0.8rem;
        }

        /* BOTONES PRINCIPALES */
        .btn-action {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-action:hover {
            background: #219150;
        }

        .btn-vroom {
            background: var(--vroom);
        }

        .btn-vroom:hover {
            background: #7d3c98;
        }

        .btn-clear {
            background: var(--danger);
            margin-top: 8px;
        }

        /* MAPA & PANEL */
        #map {
            flex: 1;
            background: #eee;
        }

        #data-panel {
            height: 250px;
            background: white;
            border-top: 3px solid var(--accent);
            display: flex;
            flex-direction: column;
            transition: height 0.3s;
            z-index: 20;
        }

        .panel-tabs {
            display: flex;
            background: #f1f1f1;
            border-bottom: 1px solid #ddd;
        }

        .panel-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
        }

        .panel-tab.active {
            background: white;
            color: var(--accent);
            border-top: 3px solid var(--accent);
            margin-top: -3px;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
        }

        .json-pre {
            white-space: pre-wrap;
            color: #2c3e50;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }

        /* MODAL */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #modal-header {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-footer {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .half-row {
            display: flex;
            gap: 10px;
        }
    </style>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdY17gpwgszK7sKVQRlsuDCvM4XNQEmrU&libraries=geometry"></script>
</head>

<body>

    <div id="app">
        <div id="main-area">
            <aside id="sidebar">
                <div id="sidebar-header">
                    <h2>OSRM & VROOM</h2>
                    <small>Master API UI (Port 5200)</small>
                </div>
                <div id="sidebar-content">

                    <div class="control-group" style="border-left: 4px solid var(--accent);">
                        <h4>1. Flota (Veh√≠culo Principal)</h4>
                        <select id="vehicle-profile" class="vehicle-select" onchange="onProfileChange()">
                            <option value="car">üöó Carro (osrm-car)</option>
                            <option value="moto">üèçÔ∏è Moto (osrm-moto)</option>
                            <option value="van">üöê Van (osrm-van)</option>
                            <option value="truck_medium">üöö Cami√≥n Medio</option>
                            <option value="truck_heavy">üöõ Cami√≥n Pesado</option>
                        </select>

                        <div id="vroom-vehicle-config"
                            style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc;">
                            <div class="half-row">
                                <div><label>Capacidad</label><input type="number" id="v-capacity" value="100"></div>
                                <div><label>Skills (ej: 1,2)</label><input type="text" id="v-skills" placeholder="1, 2">
                                </div>
                            </div>
                            <div class="half-row">
                                <div><label>Inicio Turno (s)</label><input type="number" id="v-start-time" value="0">
                                </div>
                                <div><label>Fin Turno (s)</label><input type="number" id="v-end-time" value="28800">
                                </div>
                            </div>
                        </div>

                        <div style="font-size: 0.75rem; color:#666; margin-top:5px">
                            <span id="vroom-port-display">VROOM Port: 5200</span>
                        </div>
                    </div>

                    <div class="service-tabs">
                        <div class="tab-btn active" onclick="setService('route')">Ruta</div>
                        <div class="tab-btn" onclick="setService('trip')">TSP</div>
                        <div class="tab-btn" onclick="setService('vroom')">VROOM</div>
                        <div class="tab-btn" onclick="setService('table')">Matriz</div>
                    </div>

                    <p id="desc-text" style="font-size: 0.8rem; color: #666; font-style: italic; margin-bottom: 10px;">
                        Ruta punto a punto est√°ndar.
                    </p>

                    <div id="params-container"></div>

                    <div class="control-group">
                        <h4>Puntos (<span id="point-count">0</span>)</h4>
                        <ul id="point-list">
                            <li style="font-style:italic; color:#999;">Haz clic en el mapa...</li>
                        </ul>
                    </div>

                    <button id="btn-execute" class="btn-action" onclick="executeService()">CALCULAR</button>
                    <button class="btn-action btn-clear" onclick="clearAll()">LIMPIAR</button>
                </div>
            </aside>

            <div id="map"></div>
        </div>

        <div id="data-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="setPanelTab('summary')">Resumen</div>
                <div class="panel-tab" onclick="setPanelTab('json')">JSON</div>
                <div class="panel-tab" onclick="togglePanel()" style="margin-left: auto;">‚Üï</div>
            </div>
            <div id="panel-content-area" class="panel-content">
                <div id="view-summary">Esperando datos...</div>
                <div id="view-json" style="display:none;">
                    <pre class="json-pre">{}</pre>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <div id="modal-header">Editar Trabajo / Punto</div>
            <input type="hidden" id="edit-id">

            <label>Demanda / Entrega</label>
            <input type="number" id="edit-delivery" value="10">

            <label>Tiempo Servicio (segundos)</label>
            <input type="number" id="edit-service" value="300">

            <div class="half-row">
                <div>
                    <label>Ventana Inicio</label>
                    <input type="number" id="edit-tw-start" placeholder="0">
                </div>
                <div>
                    <label>Ventana Fin</label>
                    <input type="number" id="edit-tw-end" placeholder="86400">
                </div>
            </div>

            <div class="half-row">
                <div>
                    <label>Prioridad (0-100)</label>
                    <input type="number" id="edit-priority" value="50">
                </div>
                <div>
                    <label>Skills Req.</label>
                    <input type="text" id="edit-skills" placeholder="ej: 1">
                </div>
            </div>

            <div class="modal-footer">
                <button onclick="closeModal()"
                    style="padding:8px; border:none; background:#ccc; cursor:pointer; border-radius:4px;">Cancelar</button>
                <button onclick="savePointData()"
                    style="padding:8px; border:none; background:var(--accent); color:white; cursor:pointer; border-radius:4px;">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const API_VROOM = "http://localhost:5200";
        const HOST = "http://localhost";

        const PROFILES = {
            car: { directPort: 5000, vroomProfile: "car" },
            moto: { directPort: 5001, vroomProfile: "moto" },
            van: { directPort: 5002, vroomProfile: "van" },
            truck_medium: { directPort: 5003, vroomProfile: "truck_medium" },
            truck_heavy: { directPort: 5004, vroomProfile: "truck_heavy" }
        };

        // --- ESTADO ---
        let currentService = 'route';
        let currentProfileKey = 'car';
        let map;
        let points = [];
        let resultObjects = [];
        let isPanelOpen = true;

        const servicesConfig = {
            route: { desc: "Ruta A -> B (Orden fijo)", params: `<div class="checkbox-row"><input type="checkbox" id="p-steps" checked> Steps</div>` },
            trip: { desc: "TSP (Viajero Comerciante)", params: `<select id="p-roundtrip"><option value="true">Circular</option><option value="false">Lineal</option></select>` },
            vroom: { desc: "Optimizaci√≥n VROOM (Time Windows, Skills)", params: `` }, // Params moved to sidebar top
            table: { desc: "Matriz NxM", params: `<select id="p-annotations"><option value="duration">Duraci√≥n</option></select>` }
        };

        function initMap() {
            const mapEl = document.getElementById('map');
            if (!mapEl) return;
            map = new google.maps.Map(mapEl, { zoom: 13, center: { lat: 4.62, lng: -74.10 }, disableDefaultUI: true, zoomControl: true });
            map.addListener("click", (e) => addPoint(e.latLng.lat(), e.latLng.lng()));
            setService('route');
            onProfileChange();
        }

        function onProfileChange() {
            const select = document.getElementById('vehicle-profile');
            currentProfileKey = select.value;
            const config = PROFILES[currentProfileKey];
            document.getElementById('vroom-port-display').innerText = `VROOM: ${config.vroomProfile} | Direct: ${config.directPort}`;
        }

        function setService(service) {
            currentService = service;
            // UI Update
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'vroom-active');
                if (b.innerText.toLowerCase().includes(service.substr(0, 3))) {
                    if (service === 'vroom') {
                        b.classList.add('vroom-active');
                        document.getElementById('btn-execute').classList.add('btn-vroom');
                        document.getElementById('vroom-vehicle-config').style.display = 'block';
                    } else {
                        b.classList.add('active');
                        document.getElementById('btn-execute').classList.remove('btn-vroom');
                        document.getElementById('vroom-vehicle-config').style.display = 'none';
                    }
                }
            });
            document.getElementById('desc-text').innerText = servicesConfig[service].desc;
            document.getElementById('params-container').innerHTML = servicesConfig[service].params || "";
            updatePointList();
        }

        function addPoint(lat, lng) {
            let label = (points.length + 1).toString();
            // Default Data Object for Advanced VROOM features
            const pointData = {
                lat, lng,
                marker: null,
                delivery: 10,
                service: 300,
                twStart: null,
                twEnd: null,
                priority: 50,
                skills: ""
            };

            if (currentService === 'vroom' && points.length === 0) label = "D"; // Depot

            const marker = new google.maps.Marker({
                position: { lat, lng }, map: map,
                label: { text: label, color: "white" },
                title: `Punto`
            });

            pointData.marker = marker;
            points.push(pointData);
            updatePointList();
        }

        function updatePointList() {
            const list = document.getElementById('point-list');
            document.getElementById('point-count').innerText = points.length;
            list.innerHTML = "";

            points.forEach((p, i) => {
                let role = `P${i + 1}`;
                let isDepot = false;
                if (currentService === 'vroom' && i === 0) {
                    role = "üè¢ Dep√≥sito";
                    isDepot = true;
                } else if (currentService === 'vroom') {
                    role = `üì¶ Job ${i}`;
                }

                let html = `<li>
                    <div>
                        <strong>${role}</strong><br>
                        <small style="color:#888">${p.lat.toFixed(3)}, ${p.lng.toFixed(3)}</small>
                    </div>`;

                // Bot√≥n editar solo para Jobs (no Dep√≥sito en v1)
                if (!isDepot && currentService === 'vroom') {
                    html += `<div class="point-actions">
                                <button class="btn-edit" onclick="openModal(${i})">‚öôÔ∏è</button>
                                <button class="btn-del" onclick="removePoint(${i})">‚úñ</button>
                             </div>`;
                } else if (!isDepot) {
                    html += `<div class="point-actions"><button class="btn-del" onclick="removePoint(${i})">‚úñ</button></div>`;
                }

                html += `</li>`;
                list.innerHTML += html;
            });
        }

        function removePoint(index) {
            points[index].marker.setMap(null);
            points.splice(index, 1);
            // Re-label markers
            points.forEach((p, i) => {
                let label = (i + 1).toString();
                if (currentService === 'vroom') label = i === 0 ? "D" : i.toString();
                p.marker.setLabel({ text: label, color: "white" });
            });
            updatePointList();
        }

        function clearAll() {
            points.forEach(p => p.marker.setMap(null));
            resultObjects.forEach(o => o.setMap(null));
            points = []; resultObjects = [];
            updatePointList();
            document.getElementById('view-summary').innerText = "Esperando datos...";
            document.getElementById('view-json').style.display = 'none';
        }

        // --- MODAL LOGIC ---
        function openModal(index) {
            const p = points[index];
            document.getElementById('edit-id').value = index;
            document.getElementById('edit-delivery').value = p.delivery;
            document.getElementById('edit-service').value = p.service;
            document.getElementById('edit-tw-start').value = p.twStart;
            document.getElementById('edit-tw-end').value = p.twEnd;
            document.getElementById('edit-priority').value = p.priority;
            document.getElementById('edit-skills').value = p.skills;

            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function savePointData() {
            const index = parseInt(document.getElementById('edit-id').value);
            const p = points[index];

            p.delivery = parseInt(document.getElementById('edit-delivery').value) || 0;
            p.service = parseInt(document.getElementById('edit-service').value) || 0;
            p.twStart = document.getElementById('edit-tw-start').value ? parseInt(document.getElementById('edit-tw-start').value) : null;
            p.twEnd = document.getElementById('edit-tw-end').value ? parseInt(document.getElementById('edit-tw-end').value) : null;
            p.priority = parseInt(document.getElementById('edit-priority').value) || 50;
            p.skills = document.getElementById('edit-skills').value;

            closeModal();
            // Visual feedback could be added here
            alert(`Job ${index} actualizado.`);
        }

        // --- API EXECUTION ---
        async function executeService() {
            if (points.length < 2) { alert("M√≠nimo 2 puntos."); return; }
            const statusDiv = document.getElementById('view-summary');
            statusDiv.innerHTML = "‚è≥ Enviando a API Master...";

            const profileConfig = PROFILES[currentProfileKey];
            let url = "", method = "GET", body = null;

            try {
                if (currentService === 'vroom') {
                    url = API_VROOM + "/";
                    method = "POST";
                    const depot = points[0];

                    // Vehicle Config
                    const vCap = parseInt(document.getElementById('v-capacity').value);
                    const vSkillsStr = document.getElementById('v-skills').value;
                    const vSkills = vSkillsStr ? vSkillsStr.split(',').map(Number) : undefined;
                    const vStartT = parseInt(document.getElementById('v-start-time').value);
                    const vEndT = parseInt(document.getElementById('v-end-time').value);

                    const payload = {
                        vehicles: [{
                            id: 1,
                            profile: profileConfig.vroomProfile,
                            start: [depot.lng, depot.lat],
                            end: [depot.lng, depot.lat],
                            capacity: [vCap],
                            skills: vSkills,
                            time_window: [vStartT, vEndT]
                        }],
                        jobs: points.slice(1).map((p, idx) => {
                            const job = {
                                id: idx + 1,
                                location: [p.lng, p.lat],
                                delivery: [p.delivery],
                                service: p.service,
                                priority: p.priority
                            };
                            // Add optional fields only if set
                            if (p.twStart !== null && p.twEnd !== null) {
                                job.time_windows = [[p.twStart, p.twEnd]];
                            }
                            if (p.skills) {
                                job.skills = p.skills.split(',').map(Number);
                            }
                            return job;
                        }),
                        options: { g: true }
                    };
                    body = JSON.stringify(payload);
                }
                else {
                    // OSRM STANDARD LOGIC
                    const port = profileConfig.directPort;
                    const coords = points.map(p => `${p.lng},${p.lat}`).join(';');
                    url = `${HOST}:${port}/${currentService}/v1/driving/${coords}?overview=full&geometries=polyline`;
                    if (currentService === 'trip') url += `&roundtrip=${document.getElementById('p-roundtrip').value}`;
                    if (currentService === 'table') url += `&annotations=duration`;
                }

                console.log("Payload:", body);

                const res = await fetch(url, { method, headers: body ? { 'Content-Type': 'application/json' } : undefined, body });
                const data = await res.json();

                document.querySelector('#view-json .json-pre').innerText = JSON.stringify(data, null, 2);
                renderResults(data);

            } catch (e) {
                statusDiv.innerHTML = `<div style="color:red;">Error: ${e.message}</div>`;
                console.error(e);
            }
        }

        function renderResults(data) {
            resultObjects.forEach(o => o.setMap(null));
            resultObjects = [];
            const container = document.getElementById('view-summary');
            container.innerHTML = "";

            if (currentService === 'vroom') {
                if (data.routes && data.routes.length > 0) {
                    let html = `<h4>VROOM Result</h4>`;

                    // Iterar sobre TODAS las rutas (si VROOM usa m√∫ltiples veh√≠culos)
                    const colors = ['#8e44ad', '#e67e22', '#2980b9', '#c0392b'];

                    data.routes.forEach((r, idx) => {
                        const color = colors[idx % colors.length];
                        if (r.geometry) drawPolyline(r.geometry, color);

                        html += `<div style="border-left:3px solid ${color}; padding-left:5px; margin-bottom:10px;">
                                    <strong>Veh√≠culo ${r.vehicle}</strong><br>
                                    Dist: ${(r.distance / 1000).toFixed(1)}km | Dur: ${(r.duration / 60).toFixed(0)}min
                                    <ul style="font-size:0.8rem; padding-left:15px; margin:5px 0;">`;

                        r.steps.forEach((s) => {
                            if (s.type === 'job') html += `<li>Job ${s.job} (Arrive: ${formatTime(s.arrival)})</li>`;
                            else html += `<li>${s.type}</li>`;
                        });
                        html += `</ul></div>`;
                    });

                    if (data.unassigned && data.unassigned.length > 0) {
                        html += `<div style="color:red; font-weight:bold; margin-top:10px;">
                                    ‚ö†Ô∏è Sin asignar: ${data.unassigned.length} trabajos
                                 </div>`;
                        data.unassigned.forEach(u => {
                            html += `<small>Job ${u.id}: Capacity/Skill issue?</small><br>`;
                        });
                    }
                    container.innerHTML = html;
                } else {
                    container.innerHTML = "No solution found.";
                }
            } else {
                // Logic OSRM Standard (igual que antes)
                if (data.routes || data.trips) {
                    const routes = data.routes || data.trips;
                    routes.forEach((r, i) => {
                        if (r.geometry) drawPolyline(r.geometry, '#3498db');
                        container.innerHTML += `<div>Ruta: ${(r.distance / 1000).toFixed(2)}km</div>`;
                    });
                }
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}:${m.toString().padStart(2, '0')}`;
        }

        function drawPolyline(encoded, color) {
            const path = google.maps.geometry.encoding.decodePath(encoded);
            const poly = new google.maps.Polyline({ path, strokeColor: color, strokeWeight: 5, map });
            resultObjects.push(poly);
            const bounds = new google.maps.LatLngBounds();
            path.forEach(p => bounds.extend(p));
            map.fitBounds(bounds);
        }

        function setPanelTab(t) {
            // (Igual que antes)
            document.querySelectorAll('.panel-tab').forEach(x => x.classList.remove('active'));
            if (t === 'summary') {
                document.getElementById('view-summary').style.display = 'block';
                document.getElementById('view-json').style.display = 'none';
                document.querySelectorAll('.panel-tab')[0].classList.add('active');
            } else {
                document.getElementById('view-summary').style.display = 'none';
                document.getElementById('view-json').style.display = 'block';
                document.querySelectorAll('.panel-tab')[1].classList.add('active');
            }
        }
        function togglePanel() {
            const p = document.getElementById('data-panel');
            p.style.height = isPanelOpen ? '45px' : '250px';
            isPanelOpen = !isPanelOpen;
        }

        window.onload = initMap;
    </script>
</body>

</html>